<!DOCTYPE html> 
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Chamados - Ajustado</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
* { box-sizing: border-box; }

body {
  font-family: 'Segoe UI', Arial, sans-serif;
  margin: 0;
  padding: 0;
  background: #cbd3da;
  font-size: 13px;
  display: flex;
  justify-content: center;
  align-items: center; /* Centraliza verticalmente */
  height: 100vh; /* Ocupa exatamente a altura da tela */
  overflow: hidden; /* Remove a barra de rolagem da p치gina principal */
}

#mainframe {
  width: 95%; /* Mant칠m margem nas laterais */
  max-width: 1300px;
  height: calc(100vh - 60px); /* Garante margem de 30px superior e inferior */
  background: #fff;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.15);
  display: flex;
  flex-direction: column;
}

.header-bar {
  background: #0b5d3b;
  color: #fff;
  padding: 10px 15px;
  border-radius: 6px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  flex-shrink: 0; /* Impede o cabe칞alho de encolher */
}

.container-principal {
  display: grid;
  grid-template-columns: 450px 1fr;
  gap: 15px;
  flex: 1; /* Faz o container ocupar o resto do espa칞o */
  overflow: hidden; /* Impede que o container estique a p치gina */
}

.modulo-painel {
  border: 1px solid #0b5d3b;
  border-radius: 6px;
  background: #fff;
  display: flex;
  flex-direction: column;
  height: 100%; /* Ocupa toda a altura dispon칤vel do container */
  overflow: hidden;
}

.panel-header {
  background: #0b5d3b;
  color: #fff;
  padding: 7px 12px;
  font-size: 13px;
  font-weight: bold;
  flex-shrink: 0;
}

.form-area { 
  padding: 10px; 
  overflow-y: auto; /* Permite rolagem apenas dentro do formul치rio */
  flex: 1; 
}

.painel-direito {
  display: flex;
  flex-direction: column;
  gap: 12px;
  height: 100%;
}

.campo-linha { display: flex; flex-direction: column; margin-bottom: 5px; }
.campo-linha label { font-size: 11px; font-weight: bold; margin-bottom: 2px; color: #333; }

input, select, textarea { 
  width: 100%; 
  padding: 5px 8px; 
  border: 1px solid #ced4da; 
  border-radius: 4px; 
  font-size: 12px;
}

/* Consulta de Selo */
.secao-consulta { 
  display: grid; 
  grid-template-columns: 1fr 1fr 1fr; 
  gap: 8px; 
  padding: 10px; 
  background: #f8f9fa; 
  flex-shrink: 0;
}

.resultado-grid { 
  display: grid; 
  grid-template-columns: repeat(6, 1fr); 
  gap: 5px; 
  padding: 10px; 
  background: #fff;
  flex-shrink: 0;
}

.mini-label { font-size: 10px; font-weight: bold; display: block; margin-bottom: 2px; }

/* Tabela de Chamados Recentes */
.tabela-container { 
  flex: 1; 
  overflow-y: auto; /* Permite rolagem apenas dentro da tabela */
}

table { width: 100%; border-collapse: collapse; font-size: 11px; }
th, td { border-bottom: 1px solid #eee; padding: 7px; text-align: left; }
th { background: #f8f9fa; position: sticky; top: 0; z-index: 5; }

button { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; font-size: 11px; }
.btn-save { background: #007bff; color: #fff; }
.btn-txt { background: #28a745; color: #fff; }
.btn-nav { background: #6fcf97; color: #0b5d3b; }
.btn-gray { background: #6c757d; color: #fff; }

/* Personaliza칞칚o da barra de rolagem interna */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: #f1f1f1; }
::-webkit-scrollbar-thumb { background: #0b5d3b; border-radius: 10px; }
</style>
</head>
<body>

<div id="mainframe">
  <div class="header-bar">
    <h2 style="margin:0; font-size:16px;">SISTEMA DE CHAMADOS</h2>
    <button class="btn-nav" onclick="window.open('https://docs.google.com/spreadsheets/d/1142MfU41euisLbUfpOJz_xEffv4YndQeFlqNatGf1kU/edit', '_blank')">游늵 ABRIR PLANILHA</button>
  </div>

  <div class="container-principal">
    <div class="modulo-painel">
      <div class="panel-header">游닇 NOVO CHAMADO</div>
      <div class="form-area">
        <div class="campo-linha"><label>T칤tulo</label><input id="titulo" type="text" placeholder="Ex: BRASKEM - RJ - INC..."></div>
        <div class="campo-linha"><label>Solicitante</label><input id="solicitante" type="text"></div>
        <div class="campo-linha"><label>Login</label><input id="login" type="text"></div>
        <div class="campo-linha"><label>CC</label><input id="cc" type="text"></div>
        <div class="campo-linha"><label>Unidade</label><input id="unidade" type="text"></div>
        <div class="campo-linha"><label>Departamento</label><input id="departamento" type="text"></div>
        <div class="campo-linha"><label>Contato</label><input id="contato" type="text"></div>
        <div class="campo-linha"><label>Email</label><input id="email" type="email"></div>
        <div class="campo-linha"><label>Previs칚o de entrega</label><input id="previsao" type="date"></div>
        <div class="campo-linha"><label>Descri칞칚o</label><textarea id="descricao" style="height:60px;"></textarea></div>
        <div class="campo-linha"><label>Equipamento</label><input id="equipamento" type="text"></div>
        <div style="display:flex; justify-content:flex-end; gap:6px; margin-top:10px">
          <button class="btn-save" onclick="salvarChamado()">SALVAR</button>
          <button class="btn-txt" onclick="gerarTXT()">GERAR TXT</button>
        </div>
      </div>
    </div>

    <div class="painel-direito">
      <div class="modulo-painel" style="height: auto;">
        <div class="panel-header">游댌 CONSULTA DE SELO</div>
        <div class="secao-consulta">
          <div>
            <label class="mini-label">Arquivo Local</label>
            <div style="display:flex; gap:2px">
              <input id="nomeArq" readonly style="font-size:10px; height:28px">
              <button class="btn-gray" onclick="document.getElementById('fileIn').click()" style="padding:0 8px">游늭</button>
              <input type="file" id="fileIn" accept=".xlsx,.xls" style="display:none">
            </div>
          </div>
          <div>
            <label class="mini-label">Google Drive</label>
            <div style="display:flex; gap:2px">
              <select id="selDrive" style="height:28px">
                <option value="">Selecione...</option>
                <option value="rj">BRASKEM RJ</option>
                <option value="sp">BRASKEM SP</option>
              </select>
              <button id="btnCarregarDrive" class="btn-save" style="padding:0 8px">OK</button>
            </div>
          </div>
          <div>
            <label class="mini-label">Selo de Garantia</label>
            <div style="display:flex; gap:2px">
              <input id="patIn" placeholder="Selo..." style="height:28px">
              <button id="btnBuscar" class="btn-save" style="background:#4da3ff; padding:0 10px" disabled>游댌</button>
            </div>
          </div>
        </div>
        <div class="resultado-grid">
          <div><label class="mini-label">Modelo</label><input id="resModelo" readonly></div>
          <div><label class="mini-label">Departamento</label><input id="resDepto" readonly></div>
          <div><label class="mini-label">Usu치rio</label><input id="resUser" readonly></div>
          <div><label class="mini-label">Login</label><input id="resLogin" readonly></div>
          <div><label class="mini-label">CC</label><input id="resCC" readonly></div>
          <div><label class="mini-label">Selo</label><input id="resSelo" readonly></div>
        </div>
      </div>

      <div class="modulo-painel" style="flex: 1;">
        <div class="panel-header">游늶 CHAMADOS RECENTES</div>
        <div class="tabela-container">
          <table>
            <thead><tr><th>Data</th><th>T칤tulo</th><th>Solicitante</th><th>A칞칚o</th></tr></thead>
            <tbody id="listaChamados"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz9jqdg60ZbO8C6zHC3DkvIPglkL5jgMTQDctLsY3FdapoFyOrtnrtmZNZpL-b30oEyZw/exec';
const PLANILHAS_DRIVE = {
  rj: '14Htn3BT26Pvrd0NIYGRjuJFDspLJHMM0CKOJ1sGTfAs',
  sp: '1FD6eEKzuv5aabtVlmrHnIxtT-hq6HGs49-jiUdNIUsY'
};

let dadosPlanilha = [];

window.onload = carregarChamados;

document.getElementById('btnCarregarDrive').addEventListener('click', async function() {
  const pId = document.getElementById('selDrive').value;
  if(!pId) return;
  this.innerText = '...';
  try {
    const r = await fetch(`${WEB_APP_URL}?action=getPlanilha&id=${PLANILHAS_DRIVE[pId]}`);
    dadosPlanilha = await r.json();
    document.getElementById('btnBuscar').disabled = false;
    this.innerText = 'OK';
    alert('Base carregada!');
  } catch (e) { alert('Erro ao conectar.'); this.innerText = 'OK'; }
});

async function carregarChamados() {
  try {
    const r = await fetch(WEB_APP_URL);
    const data = await r.json();
    const tbody = document.getElementById('listaChamados');
    tbody.innerHTML = '';
    data.slice(1).reverse().forEach(row => {
      let dataTxt = row[0];
      if (dataTxt && (dataTxt.includes('T') || dataTxt.includes('-'))) {
          const d = new Date(dataTxt);
          dataTxt = d.toLocaleDateString('pt-BR');
      }
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${dataTxt}</td><td>${row[1]}</td><td>${row[2]}</td><td><button class="btn-txt" style="padding:2px 6px">Ver</button></td>`;
      tbody.appendChild(tr);
    });
  } catch (e) { console.error('Erro na tabela'); }
}

async function salvarChamado() {
  const params = new URLSearchParams();
  const campos = ['titulo','solicitante','login','cc','unidade','departamento','contato','email','previsao','descricao','equipamento'];
  campos.forEach(id => params.append(id, document.getElementById(id).value));
  try {
    await fetch(WEB_APP_URL, { method:'POST', body:params });
    alert('Salvo!');
    campos.forEach(id => document.getElementById(id).value = '');
    carregarChamados();
  } catch(e) { alert('Erro ao salvar.'); }
}

function gerarTXT() {
  const texto = `T칈TULO: ${document.getElementById('titulo').value}`;
  const blob = new Blob([texto], {type:'text/plain'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'chamado.txt';
  link.click();
}
</script>
</body>
</html>
