<!DOCTYPE html> 
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Chamados</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
* { box-sizing: border-box; }

body {
  font-family: 'Segoe UI', Arial, sans-serif;
  margin: 0;
  padding: 10px;
  background: #e9ecef;
  font-size: 13px; /* Fonte menor para evitar o aspecto "aumentado" */
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  overflow: hidden;
}

#mainframe {
  width: 100%;
  max-width: 1600px;
  height: 95vh;
  background: #fff;
  padding: 12px;
  border-radius: 8px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  display: flex;
  flex-direction: column;
}

.header-bar {
  background: #0b5d3b;
  color: #fff;
  padding: 8px 15px;
  border-radius: 6px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.container-principal {
  display: grid;
  grid-template-columns: 550px 1fr; /* Coluna levemente menor para ganhar espa√ßo */
  gap: 12px;
  flex: 1;
  overflow: hidden;
}

.modulo-painel {
  border: 1px solid #0b5d3b;
  border-radius: 6px;
  background: #fff;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.panel-header {
  background: #0b5d3b;
  color: #fff;
  padding: 6px 12px;
  font-size: 13px;
  font-weight: bold;
}

.form-area { padding: 8px; overflow-y: auto; flex: 1; }
.campo-linha { display: flex; flex-direction: column; margin-bottom: 4px; }
.campo-linha label { font-size: 12px; font-weight: bold; margin-bottom: 2px; color: #333; }

input, select, textarea { 
  width: 100%; 
  padding: 4px 8px; 
  border: 1px solid #ced4da; 
  border-radius: 4px; 
  font-size: 13px; /* Fonte compacta */
}

/* Layout Consulta Selo - Fiel ao original */
.secao-consulta { 
  display: grid; 
  grid-template-columns: 1.2fr 1fr 1fr; 
  gap: 8px; 
  padding: 10px; 
  background: #f8f9fa; 
  border-bottom: 1px solid #eee;
}

.resultado-grid { 
  display: grid; 
  grid-template-columns: repeat(6, 1fr); 
  gap: 5px; 
  padding: 10px; 
  background: #fff;
}

.mini-label { font-size: 11px; font-weight: bold; display: block; margin-bottom: 2px; }

.tabela-container { flex: 1; overflow-y: auto; }
table { width: 100%; border-collapse: collapse; font-size: 11.5px; }
th, td { border-bottom: 1px solid #eee; padding: 6px; text-align: left; }
th { background: #f8f9fa; position: sticky; top: 0; }

button { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; font-size: 12px; }
.btn-save { background: #007bff; color: #fff; }
.btn-txt { background: #28a745; color: #fff; }
.btn-nav { background: #6fcf97; color: #0b5d3b; }
.btn-gray { background: #6c757d; color: #fff; }

@media (max-width: 1100px) {
  .container-principal { grid-template-columns: 1fr; overflow-y: auto; }
  body { height: auto; overflow: auto; }
  #mainframe { height: auto; }
}
</style>
</head>
<body>

<div id="mainframe">
  <div class="header-bar">
    <h2 style="margin:0; font-size:16px;">SISTEMA DE CHAMADOS</h2>
    <button class="btn-nav" onclick="window.open('https://docs.google.com/spreadsheets/d/1142MfU41euisLbUfpOJz_xEffv4YndQeFlqNatGf1kU/edit', '_blank')">üìä ABRIR PLANILHA</button>
  </div>

  <div class="container-principal">
    <div class="modulo-painel">
      <div class="panel-header">üìù NOVO CHAMADO</div>
      <div class="form-area">
        <div class="campo-linha"><label>T√≠tulo</label><input id="titulo" type="text" placeholder="Ex: BRASKEM - RJ - INC1051857..."></div>
        <div class="campo-linha"><label>Solicitante</label><input id="solicitante" type="text"></div>
        <div class="campo-linha"><label>Login</label><input id="login" type="text"></div>
        <div class="campo-linha"><label>CC</label><input id="cc" type="text"></div>
        <div class="campo-linha"><label>Unidade</label><input id="unidade" type="text"></div>
        <div class="campo-linha"><label>Departamento</label><input id="departamento" type="text"></div>
        <div class="campo-linha"><label>Contato</label><input id="contato" type="text"></div>
        <div class="campo-linha"><label>Email</label><input id="email" type="email"></div>
        <div class="campo-linha"><label>Previs√£o de entrega</label><input id="previsao" type="date"></div>
        <div class="campo-linha"><label>Descri√ß√£o</label><textarea id="descricao" style="height:40px;"></textarea></div>
        <div class="campo-linha"><label>Equipamento</label><input id="equipamento" type="text"></div>
        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px">
          <button class="btn-save" onclick="salvarChamado()">SALVAR</button>
          <button class="btn-txt" onclick="gerarTXT()">GERAR TXT</button>
        </div>
      </div>
    </div>

    <div class="painel-direito" style="display:flex; flex-direction:column; gap:12px; overflow:hidden;">
      <div class="modulo-painel">
        <div class="panel-header">üîç CONSULTA DE SELO</div>
        <div class="secao-consulta">
          <div>
            <label class="mini-label">Arquivo Local</label>
            <div style="display:flex; gap:2px">
              <input id="nomeArq" readonly placeholder="Nenhum arquivo" style="background:#f9f9f9">
              <button class="btn-gray" onclick="document.getElementById('fileIn').click()" style="padding:4px 8px">üìÇ</button>
              <input type="file" id="fileIn" accept=".xlsx,.xls" style="display:none">
            </div>
          </div>
          <div>
            <label class="mini-label">Google Drive</label>
            <div style="display:flex; gap:2px">
              <select id="selDrive">
                <option value="">Selecione...</option>
                <option value="rj">BRASKEM RJ</option>
                <option value="sp">BRASKEM SP</option>
              </select>
              <button id="btnCarregarDrive" class="btn-save" style="background:#007bff; padding:4px 8px">Carregar</button>
            </div>
          </div>
          <div>
            <label class="mini-label">Selo de Garantia</label>
            <div style="display:flex; gap:2px">
              <input id="patIn" placeholder="Digite o selo">
              <button id="btnBuscar" class="btn-save" style="background:#4da3ff; padding:4px 8px" disabled>üîç</button>
            </div>
          </div>
        </div>
        <div class="resultado-grid">
          <div><label class="mini-label">Modelo</label><input id="resModelo" readonly></div>
          <div><label class="mini-label">Departamento</label><input id="resDepto" readonly></div>
          <div><label class="mini-label">Usu√°rio</label><input id="resUser" readonly></div>
          <div><label class="mini-label">Login</label><input id="resLogin" readonly></div>
          <div><label class="mini-label">CC</label><input id="resCC" readonly></div>
          <div><label class="mini-label">Selo</label><input id="resSelo" readonly></div>
        </div>
      </div>

      <div class="modulo-painel" style="flex:1; min-height:0;">
        <div class="panel-header">üìã CHAMADOS RECENTES</div>
        <div class="tabela-container">
          <table>
            <thead><tr><th>Data</th><th>T√≠tulo</th><th>Solicitante</th><th>A√ß√£o</th></tr></thead>
            <tbody id="listaChamados"><tr><td colspan="4" style="text-align:center">Carregando...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Mantendo as mesmas fun√ß√µes de script anteriores para salvar e carregar dados
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz9jqdg60ZbO8C6zHC3DkvIPglkL5jgMTQDctLsY3FdapoFyOrtnrtmZNZpL-b30oEyZw/exec';
const PLANILHAS_DRIVE = {
  rj: '14Htn3BT26Pvrd0NIYGRjuJFDspLJHMM0CKOJ1sGTfAs',
  sp: '1FD6eEKzuv5aabtVlmrHnIxtT-hq6HGs49-jiUdNIUsY'
};

let dadosPlanilha = [];

window.onload = carregarChamados;

document.getElementById('btnCarregarDrive').addEventListener('click', async function() {
  const pId = document.getElementById('selDrive').value;
  if(!pId) return;
  this.innerText = '...';
  try {
    const r = await fetch(`${WEB_APP_URL}?action=getPlanilha&id=${PLANILHAS_DRIVE[pId]}`);
    dadosPlanilha = await r.json();
    document.getElementById('btnBuscar').disabled = false;
    this.innerText = 'Carregar';
    alert('Dados carregados!');
  } catch (e) { alert('Erro de conex√£o.'); this.innerText = 'Carregar'; }
});

async function carregarChamados() {
  try {
    const r = await fetch(WEB_APP_URL);
    const data = await r.json();
    const tbody = document.getElementById('listaChamados');
    tbody.innerHTML = '';
    data.slice(1).reverse().forEach(row => {
      let dataTxt = row[0];
      if (dataTxt && dataTxt.includes('T')) {
          const d = new Date(dataTxt);
          dataTxt = d.toLocaleDateString('pt-BR');
      }
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${dataTxt}</td><td>${row[1]}</td><td>${row[2]}</td><td><button class="btn-txt" style="padding:2px 6px; font-size:11px">Ver</button></td>`;
      tbody.appendChild(tr);
    });
  } catch (e) { console.error(e); }
}

async function salvarChamado() {
  const campos = ['titulo','solicitante','login','cc','unidade','departamento','contato','email','previsao','descricao','equipamento'];
  const params = new URLSearchParams();
  campos.forEach(id => params.append(id, document.getElementById(id).value));
  try {
    await fetch(WEB_APP_URL, { method:'POST', body:params });
    alert('Salvo!');
    campos.forEach(id => document.getElementById(id).value = '');
    carregarChamados();
  } catch(e) { alert('Erro ao salvar.'); }
}

function gerarTXT() {
  const t = `T√çTULO: ${document.getElementById('titulo').value}\nDESC: ${document.getElementById('descricao').value}`;
  const blob = new Blob([t], {type:'text/plain'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'chamado.txt';
  link.click();
}
</script>
</body>
</html>
