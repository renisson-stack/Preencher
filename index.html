<!DOCTYPE html> 
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Chamados - Layout Fixo</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
* { box-sizing: border-box; }

body {
  font-family: 'Segoe UI', Arial, sans-serif;
  margin: 0;
  padding: 0;
  background: #cbd3da;
  font-size: 13px;
  display: flex;
  justify-content: center;
  align-items: center; 
  height: 100vh;
  overflow: hidden;
}

#mainframe {
  width: 95%;
  max-width: 1350px;
  height: 90vh;
  background: #fff;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.15);
  display: flex;
  flex-direction: column;
}

.header-bar {
  background: #0b5d3b;
  color: #fff;
  padding: 10px 15px;
  border-radius: 6px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  flex-shrink: 0;
}

.container-principal {
  display: grid;
  grid-template-columns: 600px 1fr;
  gap: 15px;
  flex: 1;
  min-height: 0;
}

.modulo-painel {
  border: 1px solid #0b5d3b;
  border-radius: 6px;
  background: #fff;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.panel-header {
  background: #0b5d3b;
  color: #fff;
  padding: 8px 12px;
  font-size: 13px;
  font-weight: bold;
  flex-shrink: 0;
}

.form-area { 
  padding: 10px; 
  overflow-y: auto; 
  flex: 1;
  max-height: 100%;
}

.campo-linha { display: flex; flex-direction: column; margin-bottom: 4px; }
.campo-linha label { font-size: 11px; font-weight: bold; margin-bottom: 2px; color: #333; }

input, select, textarea { 
  width: 100%; 
  padding: 5px 8px; 
  border: 1px solid #ced4da; 
  border-radius: 4px; 
  font-size: 12px;
  box-sizing: border-box;
  line-height: 1.2;
}

.secao-consulta { 
  display: grid; 
  grid-template-columns: 1fr 1fr 1fr; 
  gap: 8px; 
  padding: 10px; 
  background: #f8f9fa; 
}

.resultado-grid { 
  display: grid; 
  grid-template-columns: repeat(6, 1fr); 
  gap: 5px; 
  padding: 10px; 
}

.mini-label { font-size: 10px; font-weight: bold; display: block; margin-bottom: 2px; }

.tabela-container { 
  flex: 1; 
  overflow-y: auto; 
}

table { width: 100%; border-collapse: collapse; font-size: 11.5px; }
th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
th { background: #f8f9fa; position: sticky; top: 0; z-index: 5; }

button { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; font-size: 11px; }
.btn-save { background: #007bff; color: #fff; }
.btn-txt { background: #28a745; color: #fff; }
.btn-nav { background: #6fcf97; color: #0b5d3b; }
.btn-gray { background: #6c757d; color: #fff; }

.status-msg { font-size: 11px; margin-top: 3px; }
.found { color: green; font-weight: bold; }
.notfound { color: #c0392b; font-weight: bold; }

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: #f1f1f1; }
::-webkit-scrollbar-thumb { background: #0b5d3b; border-radius: 10px; }

@keyframes spin { 
  0% { transform: rotate(0deg); } 
  100% { transform: rotate(360deg); } 
}
</style>
</head>
<body>

<div id="mainframe">
  <div class="header-bar">
    <h2 style="margin:0; font-size:16px;">SISTEMA DE CHAMADOS</h2>
    <button class="btn-nav" onclick="window.open('https://docs.google.com/spreadsheets/d/1142MfU41euisLbUfpOJz_xEffv4YndQeFlqNatGf1kU/edit', '_blank')">üìä ABRIR PLANILHA</button>
  </div>

  <div class="container-principal">
    <div class="modulo-painel">
      <div class="panel-header">üìù NOVO CHAMADO</div>
      <div class="form-area">
        <div class="campo-linha"><label>T√≠tulo</label><input id="titulo" type="text" placeholder="BRASKEM - SP - INC1072259 - PROGRAMA√á√ÉO DE R√ÅDIO - BR SP MAUA PE7 - MANUTEN√á√ÉO"></div>
        <div class="campo-linha"><label>Solicitante</label><input id="solicitante" type="text"></div>
        <div class="campo-linha"><label>Login</label><input id="login" type="text"></div>
        <div class="campo-linha"><label>CC</label><input id="cc" type="text"></div>
        <div class="campo-linha"><label>Unidade</label><input id="unidade" type="text"></div>
        <div class="campo-linha"><label>Departamento</label><input id="departamento" type="text"></div>
        <div class="campo-linha"><label>Contato</label><input id="contato" type="text"></div>
        <div class="campo-linha"><label>Email</label><input id="email" type="email"></div>
        <div class="campo-linha"><label>Previs√£o de entrega</label><input id="previsao" type="date"></div>
        <div class="campo-linha"><label>Descri√ß√£o</label><textarea id="descricao" style="height:35px; resize:none;"></textarea></div>
        <div class="campo-linha"><label>Equipamento</label><input id="equipamento" type="text"></div>
        
        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px; padding-bottom: 3px;">
          <button class="btn-save" onclick="salvarChamado()">SALVAR</button>
          <button class="btn-txt" onclick="gerarTXT()">GERAR TXT</button>
        </div>
      </div>
    </div>

    <div style="display:flex; flex-direction:column; gap:12px; min-height:0;">
      <div class="modulo-painel" style="flex-shrink:0;">
        <div class="panel-header">üîç CONSULTA DE SELO</div>
        <div class="secao-consulta">
          <div>
            <label class="mini-label">Arquivo Local</label>
            <div style="display:flex; gap:2px">
              <input id="nomeArq" readonly style="height:30px" placeholder="Nenhum arquivo">
              <button class="btn-gray" onclick="document.getElementById('fileIn').click()">üìÇ</button>
              <input type="file" id="fileIn" accept=".xlsx,.xls" style="display:none">
            </div>
            <div id="statusArquivo" class="status-msg"></div>
          </div>
          <div>
            <label class="mini-label">Google Drive</label>
            <div style="display:flex; gap:2px">
              <select id="selDrive" style="height:30px">
                <option value="">Selecione...</option>
                <option value="rj">BRASKEM RJ</option>
                <option value="sp">BRASKEM SP</option>
              </select>
              <button id="btnCarregarDrive" class="btn-save" disabled>OK</button>
            </div>
            <div id="statusDrive" class="status-msg"></div>
          </div>
          <div>
            <label class="mini-label">Selo de Garantia</label>
            <div style="display:flex; gap:2px">
              <input id="patIn" placeholder="Selo..." style="height:30px">
              <button id="btnBuscar" class="btn-save" style="background:#4da3ff" disabled>üîç</button>
            </div>
            <div id="statusBusca" class="status-msg"></div>
          </div>
        </div>
        <div class="resultado-grid">
          <div><label class="mini-label">Modelo</label><input id="resModelo" readonly></div>
          <div><label class="mini-label">Depto</label><input id="resDepto" readonly></div>
          <div><label class="mini-label">Usu√°rio</label><input id="resUser" readonly></div>
          <div><label class="mini-label">Login</label><input id="resLogin" readonly></div>
          <div><label class="mini-label">CC</label><input id="resCC" readonly></div>
          <div><label class="mini-label">Selo</label><input id="resSelo" readonly></div>
        </div>
      </div>

      <div class="modulo-painel" style="flex:1; min-height:0;">
        <div class="panel-header">üìã CHAMADOS RECENTES</div>
        <div class="tabela-container">
          <table id="tabelaMain">
            <thead><tr><th>Data</th><th>T√≠tulo</th><th>Solicitante</th><th>A√ß√£o</th></tr></thead>
            <tbody id="listaChamados"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="modalTxt" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:999;align-items:center;justify-content:center;">
  <div style="background:#fff;width:90%;max-width:500px;padding:15px;border-radius:8px;border:2px solid #0b5d3b;">
    <h3 style="margin-top:0;color:#0b5d3b;">Pr√©-visualiza√ß√£o do Chamado</h3>
    <textarea id="txtPreview" style="width:100%;height:250px;font-family:monospace;font-size:12px;padding:10px;border:1px solid #ccc;border-radius:4px;" readonly></textarea>
    <div style="text-align:right;margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
      <button class="btn-gray" onclick="fecharModalTxt()">Fechar</button>
      <button class="btn-txt" onclick="copiarTxt()">Copiar</button>
      <button class="btn-save" onclick="baixarTXT()">Baixar TXT</button>
    </div>
  </div>
</div>

<div id="modalSalvando" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:30px;border-radius:8px;text-align:center;">
    <div style="width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #007bff;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 10px;"></div>
    <p style="font-size:13px">Processando...</p>
  </div>
</div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz9jqdg60ZbO8C6zHC3DkvIPglkL5jgMTQDctLsY3FdapoFyOrtnrtmZNZpL-b30oEyZw/exec';

const PLANILHAS_DRIVE = {
  rj: '14Htn3BT26Pvrd0NIYGRjuJFDspLJHMM0CKOJ1sGTfAs',
  sp: '1FD6eEKzuv5aabtVlmrHnIxtT-hq6HGs49-jiUdNIUsY'
};

let dadosPlanilha = [];

window.onload = carregarChamados;

// ========== CARREGAR ARQUIVO LOCAL ==========
document.getElementById('fileIn').addEventListener('change', function(e) {
  const arquivo = e.target.files[0];
  if (!arquivo) return;
  
  document.getElementById('statusArquivo').innerHTML = 'Lendo...';
  document.getElementById('nomeArq').value = arquivo.name;
  
  const reader = new FileReader();
  reader.onload = function(ev) {
    const wb = XLSX.read(ev.target.result, {type: 'binary'});
    dadosPlanilha = [];
    
    wb.SheetNames.forEach(aba => {
      const dados = XLSX.utils.sheet_to_json(wb.Sheets[aba], {header: 1});
      dados.slice(1).forEach(row => {
        if(row[4]) {
          dadosPlanilha.push({
            aba: aba,
            costCenter: row[3],
            costElement: row[4],
            login: row[5],
            nomeLogin: row[6],
            targetLocality: row[8],
            service: row[9]
          });
        }
      });
    });
    
    document.getElementById('btnBuscar').disabled = false;
    document.getElementById('statusArquivo').innerHTML = `<span class="found">‚úì ${dadosPlanilha.length} itens</span>`;
  };
  reader.readAsBinaryString(arquivo);
});

// ========== CARREGAR DO GOOGLE DRIVE ==========
document.getElementById('selDrive').addEventListener('change', function() {
  document.getElementById('btnCarregarDrive').disabled = !this.value;
});

document.getElementById('btnCarregarDrive').addEventListener('click', async function() {
  const planilhaId = document.getElementById('selDrive').value;
  const targetId = PLANILHAS_DRIVE[planilhaId];
  
  document.getElementById('statusDrive').innerHTML = 'Conectando...';
  document.getElementById('btnCarregarDrive').disabled = true;

  try {
    const response = await fetch(`${WEB_APP_URL}?action=getPlanilha&id=${targetId}`);
    const data = await response.json();
    
    dadosPlanilha = data;
    document.getElementById('btnBuscar').disabled = false;
    document.getElementById('statusDrive').innerHTML = `<span class="found">‚úì ${dadosPlanilha.length} itens</span>`;
    document.getElementById('statusArquivo').innerHTML = '';
    document.getElementById('nomeArq').value = `Drive: ${planilhaId.toUpperCase()}`;
  } catch (error) {
    document.getElementById('statusDrive').innerHTML = '<span class="notfound">‚ùå Erro</span>';
    alert('Erro ao carregar do Drive. Verifique a permiss√£o do script.');
  } finally {
    document.getElementById('btnCarregarDrive').disabled = false;
  }
});

// ========== BUSCAR SELO ==========
document.getElementById('btnBuscar').addEventListener('click', function() {
  const busca = document.getElementById('patIn').value.trim().toLowerCase();
  
  if (!busca) {
    alert('Digite um selo para buscar');
    return;
  }
  
  const encontrado = dadosPlanilha.find(item => 
    String(item.costElement).toLowerCase() === busca
  );
  
  if (!encontrado) {
    document.getElementById('statusBusca').innerHTML = '<span class="notfound">N√£o encontrado</span>';
    // Limpar campos
    ['resModelo', 'resDepto', 'resUser', 'resLogin', 'resCC', 'resSelo'].forEach(id => {
      document.getElementById(id).value = '';
    });
    return;
  }
  
  // Preencher resultados
  document.getElementById('resModelo').value = encontrado.service || '';
  document.getElementById('resDepto').value = encontrado.targetLocality || '';
  document.getElementById('resUser').value = encontrado.nomeLogin || '';
  document.getElementById('resLogin').value = encontrado.login || '';
  document.getElementById('resCC').value = encontrado.costCenter || '';
  document.getElementById('resSelo').value = encontrado.costElement || '';
  
  // Preencher formul√°rio automaticamente
  document.getElementById('login').value = encontrado.login || '';
  document.getElementById('cc').value = encontrado.costCenter || '';
  
  document.getElementById('statusBusca').innerHTML = `<span class="found">‚úì Aba: ${encontrado.aba}</span>`;
});

// ========== CARREGAR CHAMADOS ==========
async function carregarChamados() {
  try {
    const r = await fetch(WEB_APP_URL);
    const data = await r.json();
    const tbody = document.getElementById('listaChamados');
    tbody.innerHTML = '';
    
    data.slice(1).reverse().forEach(row => {
      let dTxt = row[0];
      if (dTxt && dTxt.includes('T')) {
        dTxt = new Date(dTxt).toLocaleDateString('pt-BR');
      }
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${dTxt}</td><td>${row[1]}</td><td>${row[2]}</td><td><button class="btn-txt" style="padding:2px 8px" onclick='visualizarChamado(${JSON.stringify(row)})'>Ver</button></td>`;
      tbody.appendChild(tr);
    });
  } catch (e) { 
    console.error('Erro ao carregar dados'); 
  }
}

// ========== SALVAR CHAMADO ==========
async function salvarChamado() {
  const campos = ['titulo','solicitante','login','cc','unidade','departamento','contato','email','previsao','descricao','equipamento'];
  
  // Valida√ß√£o b√°sica
  if (!document.getElementById('titulo').value.trim()) {
    alert('Por favor, preencha o t√≠tulo do chamado');
    return;
  }
  
  const params = new URLSearchParams();
  campos.forEach(id => params.append(id, document.getElementById(id).value));
  
  document.getElementById('modalSalvando').style.display = 'flex';
  
  try {
    await fetch(WEB_APP_URL, { method:'POST', body:params });
    alert('Chamado salvo com sucesso!');
    campos.forEach(id => document.getElementById(id).value = '');
    carregarChamados();
  } catch(e) { 
    alert('Erro ao salvar no servidor.'); 
  } finally {
    document.getElementById('modalSalvando').style.display = 'none';
  }
}

// ========== GERAR TXT ==========
function gerarTXT() {
  const titulo = document.getElementById('titulo').value;
  const solicitante = document.getElementById('solicitante').value;
  const login = document.getElementById('login').value;
  const cc = document.getElementById('cc').value;
  const unidade = document.getElementById('unidade').value;
  const departamento = document.getElementById('departamento').value;
  const contato = document.getElementById('contato').value;
  const email = document.getElementById('email').value;
  const previsao = document.getElementById('previsao').value;
  const descricao = document.getElementById('descricao').value;
  const equipamento = document.getElementById('equipamento').value;
  
  // Formatar data para DD/MM/AA (padr√£o BR simplificado)
  let previsaoFormatada = '';
  if (previsao) {
    const [ano, mes, dia] = previsao.split('-');
    const anoAbreviado = ano.slice(-2); // Pega os 2 √∫ltimos d√≠gitos do ano
    previsaoFormatada = `${dia}/${mes}/${anoAbreviado}`;
  }
  
  const texto = `${titulo}
Solicitante: ${solicitante}
Login: ${login}
Centro de custo: ${cc}
Unidade: ${unidade}
Departamento: ${departamento}
Contato: ${contato}
Email: ${email}
Previs√£o de entrega: ${previsaoFormatada}
Descri√ß√£o: ${descricao}
Equipamento: ${equipamento}`;
  
  document.getElementById('txtPreview').value = texto;
  document.getElementById('modalTxt').style.display = 'flex';
}

// ========== FUN√á√ïES DO MODAL ==========
function visualizarChamado(row) {
  // Formatar data de previs√£o
  let previsaoFormatada = row[9] || '';
  if (previsaoFormatada) {
    const data = new Date(previsaoFormatada);
    if (!isNaN(data.getTime())) {
      const dia = String(data.getDate()).padStart(2, '0');
      const mes = String(data.getMonth() + 1).padStart(2, '0');
      const ano = String(data.getFullYear()).slice(-2); // Pega os 2 √∫ltimos d√≠gitos
      previsaoFormatada = `${dia}/${mes}/${ano}`;
    }
  }
  
  const texto = `${row[1] || ''}
Solicitante: ${row[2] || ''}
Login: ${row[3] || ''}
Centro de custo: ${row[4] || ''}
Unidade: ${row[5] || ''}
Departamento: ${row[6] || ''}
Contato: ${row[7] || ''}
Email: ${row[8] || ''}
Previs√£o de entrega: ${previsaoFormatada}
Descri√ß√£o: ${row[10] || ''}
Equipamento: ${row[11] || ''}`;
  
  document.getElementById('txtPreview').value = texto;
  document.getElementById('modalTxt').style.display = 'flex';
}

function fecharModalTxt() {
  document.getElementById('modalTxt').style.display = 'none';
}

function copiarTxt() {
  const txtArea = document.getElementById('txtPreview');
  txtArea.select();
  document.execCommand('copy');
  alert('Texto copiado para a √°rea de transfer√™ncia!');
}

function baixarTXT() {
  const texto = document.getElementById('txtPreview').value;
  const blob = new Blob([texto], {type:'text/plain'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'chamado_detalhado.txt';
  link.click();
}
</script>
</body>
</html>
